const axios = require('axios');
const cheerio = require('cheerio');
const { v4: uuidv4 } = require('uuid');
const { filterEvents } = require('../../utils/eventFilter');

async function scrapeRogersArena() {
  console.log('ðŸ’ Scraping Rogers Arena from official site...');
  
  try {
    const response = await axios.get('https://rogersarena.com/events', {
      headers: {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36'},
      timeout: 15000
    });
    
    const $ = cheerio.load(response.data);
    const events = [];
    const seen = new Set();
    
    // Extract JSON-LD event data
    $('script[type="application/ld+json"]').each((i, el) => {
      const content = $(el).html();
      if (content && content.includes('"@type":"Event"')) {
        try {
          const data = JSON.parse(content);
          const eventList = Array.isArray(data) ? data : [data];
          
          eventList.forEach(event => {
            if (event['@type'] === 'Event' && event.name) {
              const eventUrl = event.url || 'https://rogersarena.com/events';
              
              if (!seen.has(eventUrl)) {
                seen.add(eventUrl);
                
                // Parse date from ISO format (2025-10-01T18:30:00-07:00)
                let eventDate = null;
                if (event.startDate) {
                  const dateMatch = event.startDate.match(/(\d{4})-(\d{2})-(\d{2})/);
                  if (dateMatch) {
                    eventDate = `${dateMatch[1]}-${dateMatch[2]}-${dateMatch[3]}`;
                  }
                }
                
                // Decode HTML entities in title
                const title = event.name.replace(/&#8211;/g, 'â€“').replace(/&amp;/g, '&');
                
                // Get description
                const description = event.description || `${title} at Rogers Arena, Vancouver. Major concert and sports event.`;
                
                // Get performer/category
                const performer = event.performer?.name || '';
                const category = performer.toLowerCase().includes('canuck') ? 'Sports - Hockey' : 
                                performer.toLowerCase().includes('nba') ? 'Sports - Basketball' :
                                performer.toLowerCase().includes('ufc') ? 'Sports - UFC' : 'Concert';
                
                events.push({
                  id: uuidv4(),
                  title: title,
                  description: description && description.length > 20 ? description : `${title} in Vancouver`,
                  date: eventDate,
                  url: eventUrl,
                  venue: { name: 'Rogers Arena', city: 'Vancouver' },
                  city: 'Vancouver',
                  source: 'Rogers Arena',
                  category: category,
                  price: event.offers?.price || event.offers?.lowPrice || null
                });
                
                console.log(`âœ“ ${title} | ${eventDate || 'NO DATE'}`);
              }
            }
          });
        } catch (e) {
          // Skip invalid JSON
        }
      }
    });
    
    console.log(`\nâœ… Found ${events.length} Rogers Arena events`);
    const filtered = filterEvents(events);
      console.log(`âœ… Returning ${filtered.length} valid events after filtering`);
      return filtered;
    
  } catch (error) {
    console.error('Error:', error.message);
    return [];
  }
}

module.exports = { scrape: scrapeRogersArena };
