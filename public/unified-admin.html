<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discovr Unified Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            padding-top: 20px;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1400px;
        }
        .card {
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #6f42c1;
            color: white;
            font-weight: bold;
        }
        .nav-tabs .nav-link {
            color: #495057;
            font-weight: 500;
        }
        .nav-tabs .nav-link.active {
            color: #6f42c1;
            font-weight: 600;
        }
        .tab-content {
            padding: 20px;
            background-color: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
        }
        .featured-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ffc107;
            color: #212529;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .event-card {
            cursor: pointer;
            transition: transform 0.2s;
            height: 100%;
        }
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }
        /* 3D Carousel Styles */
        .carousel-3d-container {
            perspective: 1000px;
            position: relative;
            margin: 40px auto;
            height: 400px;
            overflow: hidden;
            background: linear-gradient(145deg, #2c3338, #343a40);
            border-radius: 15px;
            box-shadow: inset 0 0 50px rgba(0,0,0,0.5);
        }
        .carousel-3d {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1s ease;
        }
        .carousel-3d-item {
            position: absolute;
            width: 300px;
            height: 380px;
            left: 50%;
            top: 10px;
            transform-style: preserve-3d;
            transition: all 0.5s ease;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-radius: 10px;
            overflow: hidden;
            background: white;
            margin-left: -150px; /* Center horizontally */
            backface-visibility: hidden;
            border: 4px solid white;
        }
        .carousel-3d-item img {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }
        .carousel-3d-item .content {
            padding: 15px;
        }
        .carousel-3d-item h4 {
            margin-top: 0;
            font-size: 1.2rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .carousel-controls {
            text-align: center;
            margin-top: 20px;
        }
        .carousel-controls button {
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="text-center mb-4">Discovr Unified Admin Dashboard</h1>
        
        <!-- Navigation Tabs -->
        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="events-tab" data-bs-toggle="tab" data-bs-target="#events-content" type="button" role="tab" aria-controls="events-content" aria-selected="true">
                    <i class="bi bi-calendar-event"></i> All Events
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="featured-tab" data-bs-toggle="tab" data-bs-target="#featured-content" type="button" role="tab" aria-controls="featured-content" aria-selected="false">
                    <i class="bi bi-star-fill"></i> Featured Events
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scrapers-tab" data-bs-toggle="tab" data-bs-target="#scrapers-content" type="button" role="tab" aria-controls="scrapers-content" aria-selected="false">
                    <i class="bi bi-robot"></i> Run Scrapers
                </button>
            </li>
        </ul>
        
        <!-- Tab Content -->
        <div class="tab-content" id="adminTabsContent">
            <!-- All Events Tab -->
            <div class="tab-pane fade show active" id="events-content" role="tabpanel" aria-labelledby="events-tab">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h3>All Events</h3>
                    </div>
                    <div class="col-md-6 text-end">
                        <button class="btn btn-success" onclick="createNewEvent()">
                            <i class="bi bi-plus-circle"></i> Create New Event
                        </button>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="input-group">
                            <input type="text" class="form-control" id="eventSearch" placeholder="Search events...">
                            <button class="btn btn-outline-secondary" type="button" onclick="filterEvents()"><i class="bi bi-search"></i></button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            <option value="Music">Music</option>
                            <option value="Art">Art</option>
                            <option value="Food">Food</option>
                            <option value="Sports">Sports</option>
                            <option value="Festival">Festival</option>
                            <option value="Theatre">Theatre</option>
                            <option value="Comedy">Comedy</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-primary w-100" onclick="filterEvents()">Filter</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-12">
                        <button class="btn btn-success w-100" onclick="createNewEvent()">
                            <i class="bi bi-plus-circle"></i> Create New Event Manually
                        </button>
                    </div>
                </div>
                
                <div class="row" id="allEventsList">
                    <div class="col-12 text-center">
                        <div class="spinner-border" role="status"></div>
                        <p>Loading events...</p>
                    </div>
                </div>
            </div>
            
            <!-- Featured Events Tab -->
            <div class="tab-pane fade" id="featured-content" role="tabpanel" aria-labelledby="featured-tab">
                <!-- Featured Events Preview -->
                <div class="card mb-4">
                    <div class="card-header">
                        Featured Events Preview (How it will appear in the app)
                    </div>
                    <div class="card-body bg-dark text-white">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3>Real Events from MongoDB</h3>
                            <button class="btn btn-success" onclick="createNewFeaturedEvent()">
                                <i class="bi bi-plus-circle"></i> Create New Event
                            </button>
                        </div>
                        
                        <div class="carousel-3d-container">
                            <div class="carousel-3d" id="carousel3d">
                                <!-- Carousel items will be inserted here -->
                            </div>
                        </div>
                        <div class="text-center mt-3">
                            <button class="btn btn-secondary" id="prevBtn"><i class="bi bi-arrow-left"></i> Previous</button>
                            <button class="btn btn-secondary" id="nextBtn">Next <i class="bi bi-arrow-right"></i></button>
                        </div>
                    </div>
                </div>
                
                <!-- Manage Featured Events -->
                <div class="card">
                    <div class="card-header">
                        Manage Featured Events
                    </div>
                    <div class="card-body">
                        <p>Select up to 10 events to feature at the top of the app. These events will appear in the "Real Events from MongoDB" section.</p>
                        
                        <div class="d-flex justify-content-start mb-3">
                            <button class="btn btn-primary me-2" id="saveFeaturedBtn">Save Featured Events</button>
                            <button class="btn btn-danger" id="clearFeaturedBtn">Clear All Featured</button>
                        </div>
                        
                        <div class="row" id="featuredEventsList">
                            <div class="col-12 text-center">
                                <div class="spinner-border" role="status"></div>
                                <p>Loading featured events...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Scrapers Tab -->
            <div class="tab-pane fade" id="scrapers-content" role="tabpanel" aria-labelledby="scrapers-tab">
                <h3>Run Scrapers</h3>
                <p>Run scrapers to fetch the latest events from various sources.</p>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Available Scrapers</div>
                            <div class="card-body">
                                <div class="list-group" id="scrapersList">
                                    <button class="list-group-item list-group-item-action" onclick="runScraper('roxy')">Roxy Events</button>
                                    <button class="list-group-item list-group-item-action" onclick="runScraper('commodore')">Commodore Events</button>
                                    <button class="list-group-item list-group-item-action" onclick="runScraper('vogue')">Vogue Theatre Events</button>
                                    <button class="list-group-item list-group-item-action" onclick="runScraper('rickshaw')">Rickshaw Theatre Events</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">Scraper Output</div>
                            <div class="card-body">
                                <div id="scraperOutput" class="bg-dark text-light p-3" style="height: 300px; overflow-y: auto; font-family: monospace;">
                                    Scraper output will appear here...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Event Edit Modal -->
    <div class="modal fade" id="eventEditModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalLabel">Edit Event</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        <div class="mb-3">
                            <label for="eventTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="eventTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="eventDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="eventDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="eventVenueName" class="form-label">Venue Name</label>
                                <input type="text" class="form-control" id="eventVenueName">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="eventLocation" class="form-label">Location</label>
                                <input type="text" class="form-control" id="eventLocation" placeholder="Vancouver, BC">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="eventStartDate" class="form-label">Start Date</label>
                                <input type="datetime-local" class="form-control" id="eventStartDate">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="eventEndDate" class="form-label">End Date</label>
                                <input type="datetime-local" class="form-control" id="eventEndDate">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="eventCategory" class="form-label">Category</label>
                                <select class="form-select" id="eventCategory">
                                    <option value="Music">Music</option>
                                    <option value="Arts">Arts</option>
                                    <option value="Sports">Sports</option>
                                    <option value="Food">Food</option>
                                    <option value="Festival">Festival</option>
                                    <option value="Community">Community</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="eventImage" class="form-label">Image URL</label>
                                <input type="url" class="form-control" id="eventImage">
                            </div>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="eventFeatured">
                            <label class="form-check-label" for="eventFeatured">Featured Event</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteEventBtn" onclick="deleteEvent()">Delete Event</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEventChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let allEvents = [];
        let featuredEvents = [];
        const MAX_FEATURED_EVENTS = 10;
        
        // DOM elements with safety check logging
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`Element with ID '${id}' not found in the DOM`);
            }
            return element;
        }
        
        // Get all required DOM elements
        const allEventsList = safeGetElement('allEventsList');
        const featuredEventsList = safeGetElement('featuredEventsList');
        const searchInput = safeGetElement('eventSearch');
        const categoryFilter = safeGetElement('categoryFilter');
        const refreshBtn = safeGetElement('refreshBtn');
        const saveFeaturedBtn = safeGetElement('saveFeaturedBtn');
        const clearFeaturedBtn = safeGetElement('clearFeaturedBtn');
        const scraperOutput = safeGetElement('scraperOutput');
        
        // Helper function to get API URL
        function getApiUrl(endpoint) {
            console.log('%c[DEBUG] Building API URL for endpoint: ' + endpoint, 'background: #ffa; color: #00a');
            
            // Make sure the endpoint starts with a slash
            const formattedEndpoint = endpoint.startsWith('/') ? endpoint : `/${endpoint}`;
            
            // Determine base URL - we're using relative URLs within the same origin
            // This ensures it works both locally and when deployed
            const baseUrl = '';
            
            // For debugging - log the full URL that will be used
            const fullUrl = baseUrl + formattedEndpoint;
            console.log('%c[DEBUG] Using API URL: ' + fullUrl, 'background: #ffa; color: #00a');
            
            // Log the full absolute URL for clarity
            const absoluteUrl = new URL(fullUrl, window.location.origin).href;
            console.log('%c[DEBUG] Absolute API URL: ' + absoluteUrl, 'background: #ffa; color: #00a');
            
            return fullUrl;
        }
        
        // Debug information
        console.log('Current hostname:', window.location.hostname);
        console.log('Current pathname:', window.location.pathname);
        console.log('Sample API URL:', getApiUrl('/api/v1/featured-events'));
        
        // Event listeners - with safety checks
        function addSafeEventListener(element, event, handler) {
            if (element) {
                element.addEventListener(event, handler);
            } else {
                console.warn(`Element for event ${event} not found`);
            }
        }
        
        // Add all event listeners safely
        addSafeEventListener(refreshBtn, 'click', loadAllEvents);
        addSafeEventListener(searchInput, 'keyup', filterEvents);
        addSafeEventListener(categoryFilter, 'change', filterEvents);
        addSafeEventListener(saveFeaturedBtn, 'click', saveFeaturedEvents);
        addSafeEventListener(clearFeaturedBtn, 'click', clearFeaturedEvents);
        
        // Load all events
        async function loadAllEvents() {
            try {
                allEventsList.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="spinner-border" role="status"></div>
                        <p>Loading events...</p>
                    </div>
                `;
                
                const response = await fetch(getApiUrl('/api/v1/events'));
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    allEvents = data.events;
                    renderAllEvents();
                } else {
                    allEventsList.innerHTML = '<div class="col-12"><p>No events found.</p></div>';
                }
            } catch (error) {
                console.error('Error loading events:', error);
                allEventsList.innerHTML = '<div class="col-12"><p class="text-danger">Error loading events. Please try again.</p></div>';
            }
        }
        
        // Load featured events
        async function loadFeaturedEvents() {
            try {
                console.log('%c[DEBUG] Starting featured events load', 'background: #ffa; color: #00a');
                featuredEventsList.innerHTML = `
                    <div class="col-12 text-center">
                        <div class="spinner-border" role="status"></div>
                        <p>Loading featured events...</p>
                    </div>
                `;
                
                // Initialize carousel with loading state
                const carousel = document.getElementById('carousel3d');
                if (carousel) {
                    carousel.innerHTML = `
                        <div class="carousel-3d-item" style="transform: rotateY(0deg) translateZ(0px)">
                            <div class="text-center p-5">
                                <div class="spinner-border text-light" role="status"></div>
                                <p class="mt-2 text-light">Loading featured events...</p>
                            </div>
                        </div>
                    `;
                }
                
                // Set a timeout to handle potential hanging requests
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Request timeout after 10 seconds')), 10000);
                });
                
                // Add detailed debug information
                console.log('%c[DEBUG] Environment details:', 'background: #ffa; color: #00a');
                console.log('  - Current URL:', window.location.href);
                console.log('  - Host:', window.location.hostname);
                console.log('  - Protocol:', window.location.protocol);
                console.log('  - API URL:', getApiUrl('/api/v1/featured-events'));
                
                // Make the API call with detailed error tracking
                let fetchResponse;
                try {
                    console.log('%c[DEBUG] Sending fetch request...', 'background: #ffa; color: #00a');
                    // Race the fetch against the timeout
                    fetchResponse = await Promise.race([
                        fetch(getApiUrl('/api/v1/featured-events')),
                        timeoutPromise
                    ]);
                    console.log('%c[DEBUG] Fetch response received', 'background: #ffa; color: #00a', fetchResponse);
                } catch (fetchError) {
                    console.error('%c[ERROR] Fetch error:', 'background: #faa; color: #a00', fetchError);
                    throw fetchError;
                }
                
                // Use the response
                const response = fetchResponse;
                
                console.log('Featured events API response status:', response.status);
                const data = await response.json();
                console.log('Featured events data:', data);
                
                if (data.events) {
                    featuredEvents = data.events;
                    console.log('Featured events loaded:', featuredEvents.length);
                    renderFeaturedEvents();
                    renderPreviewEvents();
                } else {
                    console.log('No featured events found in response');
                    featuredEventsList.innerHTML = '<div class="col-12"><p>No featured events set.</p></div>';
                    renderPreviewEvents(); // Still call this to show the empty state
                }
            } catch (error) {
                console.error('Error loading featured events:', error);
                featuredEventsList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <h5>Error loading featured events</h5>
                            <p>${error.message}</p>
                            <button class="btn btn-primary mt-2" onclick="loadFeaturedEvents()">Retry</button>
                        </div>
                    </div>
                `;
                
                // Also update the carousel to show the error
                const carousel = document.getElementById('carousel3d');
                if (carousel) {
                    carousel.innerHTML = `
                        <div class="carousel-3d-item" style="transform: rotateY(0deg) translateZ(0px)">
                            <div class="text-center p-5">
                                <div class="alert alert-danger">
                                    <h5>Error loading featured events</h5>
                                    <p>${error.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Add a button to create a featured events collection if it doesn't exist
                const controlsDiv = document.getElementById('featuredEventsControls');
                if (controlsDiv && !document.getElementById('troubleshootingSection')) {
                    controlsDiv.innerHTML += `
                        <div id="troubleshootingSection" class="alert alert-warning mt-3">
                            <h5>Troubleshooting</h5>
                            <p>If this is your first time setting up featured events, the collection might not exist yet.</p>
                            <button class="btn btn-warning" onclick="initializeFeaturedCollection()">Initialize Featured Events Collection</button>
                        </div>
                    `;
                }
            }
        }
        
        // Render all events
        function renderAllEvents() {
            if (allEvents.length === 0) {
                allEventsList.innerHTML = '<div class="col-12"><p>No events found.</p></div>';
                return;
            }
            
            let html = '';
            
            allEvents.forEach(event => {
                const isFeatured = featuredEvents.some(fe => fe._id === event._id || fe.id === event.id);
                
                html += `
                <div class="col-md-4 mb-3">
                    <div class="card event-card" data-id="${event._id || event.id}">
                        ${isFeatured ? '<span class="featured-badge">Featured</span>' : ''}
                        <img src="${event.image || 'https://via.placeholder.com/300x150?text=No+Image'}" class="card-img-top" alt="${event.title || 'Event'}" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">${event.title || 'Untitled Event'}</h5>
                            <p class="card-text">${formatVenue(event)}</p>
                            <p class="card-text"><small class="text-muted">${formatDate(event.startDate)}</small></p>
                            <div class="d-flex justify-content-between mt-3">
                                <div>
                                    <button class="btn btn-primary" onclick="openEventModal(this.closest('.card'))">
                                        <i class="bi bi-pencil-square"></i> Edit
                                    </button>
                                    ${(event.url || event.sourceUrl) ? 
                                        `<a href="${event.url || event.sourceUrl}" target="_blank" class="btn btn-outline-primary ms-2">
                                            <i class="bi bi-box-arrow-up-right"></i> View
                                        </a>` : ''
                                    }
                                </div>
                                <div>
                                    ${!isFeatured ? 
                                        `<button class="btn btn-success" onclick="addToFeatured('${event._id || event.id}')">
                                            <i class="bi bi-star-fill"></i> Feature
                                        </button>` : 
                                        `<button class="btn btn-warning" onclick="removeFeaturedEvent('${event._id || event.id}', event)">
                                            <i class="bi bi-star"></i> Unfeature
                                        </button>`
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            allEventsList.innerHTML = html;
        }
        
        // Render featured events
        function renderFeaturedEvents() {
            if (featuredEvents.length === 0) {
                featuredEventsList.innerHTML = '<div class="col-12"><p>No featured events set.</p></div>';
                return;
            }
            
            let html = '';
            
            featuredEvents.forEach(event => {
                html += `
                <div class="col-md-4 mb-3">
                    <div class="card event-card" data-id="${event._id || event.id}">
                        <span class="featured-badge">Featured</span>
                        <img src="${event.image || 'https://via.placeholder.com/300x150?text=No+Image'}" class="card-img-top" alt="${event.title || 'Event'}" style="height: 150px; object-fit: cover;">
                        <div class="card-body">
                            <h5 class="card-title">${event.title || 'Untitled Event'}</h5>
                            <p class="card-text">${formatVenue(event)}</p>
                            <p class="card-text"><small class="text-muted">${formatDate(event.startDate)}</small></p>
                            <div class="d-flex justify-content-between mt-3">
                                <button class="btn btn-primary" onclick="openEventModal(this.closest('.card'))">
                                    <i class="bi bi-pencil-square"></i> Edit
                                </button>
                                <button class="btn btn-warning" onclick="removeFeaturedEvent('${event._id || event.id}', event)">
                                    <i class="bi bi-star"></i> Unfeature
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            });
            
            featuredEventsList.innerHTML = html;
        }
        
        // Render preview events (how they will appear in the app)
        function renderPreviewEvents() {
            console.log('Rendering preview events...');
            const carousel = document.getElementById('carousel3d');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            if (!carousel) {
                console.error('Carousel element not found!');
                return;
            }
            
            if (!featuredEvents || featuredEvents.length === 0) {
                console.log('No featured events to display in carousel');
                carousel.innerHTML = `
                    <div class="carousel-3d-item" style="transform: rotateY(0deg) translateZ(0px)">
                        <div class="text-center p-5 text-light">
                            <p>No featured events to display.</p>
                            <p>Add up to 10 events to see them here.</p>
                        </div>
                    </div>
                `;
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
                return;
            }
            
            // Clear previous items
            carousel.innerHTML = '';
            
            // Current rotation angle
            let currentAngle = 0;
            let currentIndex = 0;
            
            // Calculate angle between items and radius
            const angleStep = 360 / featuredEvents.length;
            const radius = 300; // Distance from center
            
            // Create carousel items
            featuredEvents.forEach((event, index) => {
                const angle = index * angleStep;
                const item = document.createElement('div');
                item.className = 'carousel-3d-item';
                item.dataset.index = index;
                
                // Position in 3D space
                item.style.transform = `rotateY(${angle}deg) translateZ(${radius}px)`;
                
                // Add content
                item.innerHTML = `
                    <img src="${event.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${event.title || 'Event'}">
                    <div class="content">
                        <h4>${event.title || 'Untitled Event'}</h4>
                        <p>${formatVenue(event)}</p>
                        <p><small>${formatDate(event.startDate)}</small></p>
                        <p class="category badge bg-secondary">${event.category || 'Uncategorized'}</p>
                        <div class="d-flex justify-content-between mt-2">
                            <button class="btn btn-sm btn-primary" onclick="editCarouselEvent('${event._id || event.id}')">
                                <i class="bi bi-pencil"></i> Edit
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="removeCarouselEvent('${event._id || event.id}')">
                                <i class="bi bi-x-circle"></i> Remove
                            </button>
                        </div>
                    </div>
                `;
                
                carousel.appendChild(item);
            });
            
            // Enable buttons
            prevBtn.disabled = false;
            nextBtn.disabled = false;
            
            // Add event listeners for rotation
            prevBtn.onclick = () => {
                currentIndex = (currentIndex - 1 + featuredEvents.length) % featuredEvents.length;
                currentAngle += angleStep;
                carousel.style.transform = `rotateY(${currentAngle}deg)`;
            };
            
            nextBtn.onclick = () => {
                currentIndex = (currentIndex + 1) % featuredEvents.length;
                currentAngle -= angleStep;
                carousel.style.transform = `rotateY(${currentAngle}deg)`;
            };
            
            // Auto-rotate every 3 seconds
            if (window.carouselInterval) {
                clearInterval(window.carouselInterval);
            }
            
            window.carouselInterval = setInterval(() => {
                nextBtn.click();
            }, 3000);
        }
        
        // Filter events based on search and category
        function filterEvents() {
            const searchValue = searchInput.value.toLowerCase();
            const categoryValue = categoryFilter.value.toLowerCase();
            
            const filteredEvents = allEvents.filter(event => {
                // Search in title, description, venue name
                const matchesSearch = searchValue === '' || 
                    (event.title && event.title.toLowerCase().includes(searchValue)) ||
                    (event.description && event.description.toLowerCase().includes(searchValue)) ||
                    (event.venue && event.venue.name && event.venue.name.toLowerCase().includes(searchValue));
                
                // Filter by category
                const matchesCategory = categoryValue === '' || 
                    (event.category && event.category.toLowerCase() === categoryValue);
                
                return matchesSearch && matchesCategory;
            });
            
            // Update allEvents with filtered events temporarily for rendering
            const tempEvents = allEvents;
            allEvents = filteredEvents;
            renderAllEvents();
            allEvents = tempEvents; // Restore original events
        }
        
        // Create new event function
        function createNewEvent() {
            // Set modal title
            document.getElementById('eventModalLabel').textContent = 'Create New Event';
            
            // Clear form values
            document.getElementById('eventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventVenueName').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventStartDate').value = '';
            document.getElementById('eventEndDate').value = '';
            document.getElementById('eventCategory').value = '';
            document.getElementById('eventImage').value = '';
            document.getElementById('eventFeatured').checked = false;
            
            // Hide delete button for new events
            document.getElementById('deleteEventBtn').style.display = 'none';
            
            // Show modal
            const eventEditModal = new bootstrap.Modal(document.getElementById('eventEditModal'));
            eventEditModal.show();
        }
        
        // Open event edit modal
        function openEventModal(card) {
            const id = card.dataset.id;
            const event = allEvents.find(e => e._id === id || e.id === id);
            
            if (!event) {
                alert('Event not found!');
                return;
            }
            
            // Set modal title
            document.getElementById('eventModalLabel').textContent = 'Edit Event';
            
            // Set form values
            document.getElementById('eventId').value = id;
            document.getElementById('eventTitle').value = event.title || '';
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventVenueName').value = event.venue?.name || '';
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventStartDate').value = event.startDate ? formatDateForInput(event.startDate) : '';
            document.getElementById('eventEndDate').value = event.endDate ? formatDateForInput(event.endDate) : '';
            document.getElementById('eventCategory').value = event.category || '';
            document.getElementById('eventImage').value = event.image || '';
            document.getElementById('eventFeatured').checked = featuredEvents.some(fe => fe._id === id || fe.id === id);
            
            // Add delete button
            document.getElementById('deleteEventBtn').style.display = 'block';
            
            // Show modal
            const eventEditModal = new bootstrap.Modal(document.getElementById('eventEditModal'));
            eventEditModal.show();
        }
        
        // Save event changes
        async function saveEventChanges() {
            console.log('%c[DEBUG] Starting saveEventChanges()', 'background: #ffa; color: #00a');
            const id = document.getElementById('eventId').value;
            
            // Get event data from form
            const eventData = {
                // Add name field to match backend validation expectation
                name: document.getElementById('eventTitle').value,
                title: document.getElementById('eventTitle').value, // Keep title for compatibility
                description: document.getElementById('eventDescription').value,
                venue: {
                    name: document.getElementById('eventVenueName').value,
                    city: 'Vancouver',
                    state: 'BC',
                    country: 'Canada'
                },
                location: document.getElementById('eventLocation').value,
                startDate: document.getElementById('eventStartDate').value ? new Date(document.getElementById('eventStartDate').value).toISOString() : null,
                endDate: document.getElementById('eventEndDate').value ? new Date(document.getElementById('eventEndDate').value).toISOString() : null,
                category: document.getElementById('eventCategory').value,
                image: document.getElementById('eventImage').value
            };
            
            console.log('%c[DEBUG] Event data to save:', 'background: #ffa; color: #00a', eventData);
            
            try {
                let response;
                let apiUrl;
                
                if (id) {
                    // Update existing event
                    apiUrl = getApiUrl(`/api/v1/events/${id}`);
                    console.log('%c[DEBUG] Updating existing event with URL:', 'background: #ffa; color: #00a', apiUrl);
                    
                    response = await fetch(apiUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(eventData)
                    });
                } else {
                    // Create new event
                    apiUrl = getApiUrl('/api/v1/events');
                    console.log('%c[DEBUG] Creating new event with URL:', 'background: #ffa; color: #00a', apiUrl);
                    console.log('%c[DEBUG] Event data payload:', 'background: #ffa; color: #00a', JSON.stringify(eventData, null, 2));
                    
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(eventData)
                        });
                        console.log('%c[DEBUG] Raw response object:', 'background: #ffa; color: #00a', response);
                    } catch (fetchError) {
                        console.error('%c[ERROR] Network error during fetch:', 'background: #faa; color: #a00', fetchError);
                        throw new Error(`Network error: ${fetchError.message}`);
                    }
                }
                
                console.log('%c[DEBUG] Response received:', 'background: #ffa; color: #00a', response);
                
                if (response.ok) {
                    let data;
                    try {
                        data = await response.json();
                        console.log('%c[DEBUG] Response data:', 'background: #ffa; color: #00a', data);
                    } catch (jsonError) {
                        console.error('Error parsing response JSON:', jsonError);
                        throw new Error('Invalid response from server: ' + jsonError.message);
                    }
                    
                    const eventId = id || (data.event ? data.event._id || data.event.id : null);
                    console.log('%c[DEBUG] Event ID:', 'background: #ffa; color: #00a', eventId);
                    
                    if (eventId) {
                        // Handle featured status
                        const featured = document.getElementById('eventFeatured').checked;
                        console.log('%c[DEBUG] Featured status:', 'background: #ffa; color: #00a', featured);
                        
                        if (featured) {
                            // Add to featured if not already featured
                            if (!featuredEvents.some(fe => fe._id === eventId || fe.id === eventId)) {
                                console.log('%c[DEBUG] Adding to featured events...', 'background: #ffa; color: #00a');
                                await addToFeatured(eventId);
                            }
                        } else {
                            // Remove from featured if currently featured
                            if (featuredEvents.some(fe => fe._id === eventId || fe.id === eventId)) {
                                console.log('%c[DEBUG] Removing from featured events...', 'background: #ffa; color: #00a');
                                await removeFeaturedEvent(eventId);
                            }
                        }
                    } else {
                        console.warn('Could not determine event ID from response:', data);
                    }
                    
                    // Reload events
                    console.log('%c[DEBUG] Reloading events...', 'background: #ffa; color: #00a');
                    loadAllEvents();
                    loadFeaturedEvents();
                    
                    // Close modal
                    const eventEditModal = bootstrap.Modal.getInstance(document.getElementById('eventEditModal'));
                    if (eventEditModal) {
                        eventEditModal.hide();
                    } else {
                        console.warn('Could not find event edit modal instance');
                    }
                    
                    alert(id ? 'Event updated successfully!' : 'Event created successfully!');
                } else {
                    console.error('%c[ERROR] Failed API request:', 'background: #faa; color: #a00', response.status, response.statusText);
                    
                    let errorMessage = 'Failed to ' + (id ? 'update' : 'create') + ' event';
                    try {
                        // Get the raw text first for debugging
                        const rawText = await response.text();
                        console.error('%c[ERROR] Raw error response:', 'background: #faa; color: #a00', rawText);
                        
                        // Then try to parse it as JSON
                        try {
                            const errorData = JSON.parse(rawText);
                            console.error('%c[ERROR] Parsed error data:', 'background: #faa; color: #a00', errorData);
                            errorMessage = errorData.error || errorData.details || errorData.message || errorMessage;
                            if (errorData.details) errorMessage += `: ${errorData.details}`;
                        } catch (jsonError) {
                            console.error('%c[ERROR] Response is not valid JSON:', 'background: #faa; color: #a00', jsonError);
                            errorMessage += ` (Server responded with: ${rawText.substring(0, 100)}${rawText.length > 100 ? '...' : ''})`;
                        }
                    } catch (e) {
                        console.error('%c[ERROR] Could not read response body:', 'background: #faa; color: #a00', e);
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Error saving event:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Add event to featured
        async function addToFeatured(id) {
            try {
                if (featuredEvents.length >= MAX_FEATURED_EVENTS) {
                    alert(`You can only feature up to ${MAX_FEATURED_EVENTS} events. Please remove some featured events first.`);
                    return;
                }
                
                const response = await fetch('/api/v1/featured-events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ eventId: id })
                });
                
                if (response.ok) {
                    // Reload featured events
                    loadFeaturedEvents();
                    // Update UI for all events
                    renderAllEvents();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to add event to featured');
                }
            } catch (error) {
                console.error('Error adding to featured:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Remove event from featured
        async function removeFeaturedEvent(id, e) {
            if (e) {
                e.stopPropagation();
            }
            
            try {
                const response = await fetch(`/api/v1/featured-events/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Reload featured events
                    loadFeaturedEvents();
                    // Update UI for all events
                    renderAllEvents();
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to remove event from featured');
                }
            } catch (error) {
                console.error('Error removing from featured:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Save featured events order
        async function saveFeaturedEvents() {
            try {
                const response = await fetch('/api/v1/featured-events/order', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        eventIds: featuredEvents.map(event => event._id || event.id)
                    })
                });
                
                if (response.ok) {
                    alert('Featured events saved successfully!');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to save featured events');
                }
            } catch (error) {
                console.error('Error saving featured events:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Clear all featured events
        async function clearFeaturedEvents() {
            if (!confirm('Are you sure you want to clear all featured events?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/v1/featured-events', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Reload featured events
                    loadFeaturedEvents();
                    // Update UI for all events
                    renderAllEvents();
                    
                    alert('All featured events cleared successfully!');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to clear featured events');
                }
            } catch (error) {
                console.error('Error clearing featured events:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Run a scraper
        async function runScraper(scraperName) {
            try {
                scraperOutput.innerHTML = 'Running scraper...';
                
                const response = await fetch(`/api/v1/scrape/${scraperName}`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    scraperOutput.innerHTML = `Scraper completed successfully!<br>Events added: ${data.eventsAdded || 0}<br>Events updated: ${data.eventsUpdated || 0}`;
                    
                    // Reload events
                    loadAllEvents();
                } else {
                    scraperOutput.innerHTML = `Error: ${data.error || 'Unknown error'}`;
                }
            } catch (error) {
                console.error('Error running scraper:', error);
                scraperOutput.innerHTML = `Error: ${error.message}`;
            }
        }
        
        // Helper function to format venue
        function formatVenue(event) {
            if (event.venue && event.venue.name) {
                return `${event.venue.name}, ${event.venue.city || 'Vancouver'}`;
            } else if (event.location) {
                return event.location;
            } else {
                return 'No venue information';
            }
        }
        
        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            
            const date = new Date(dateString);
            
            if (isNaN(date.getTime())) {
                return dateString; // Return as is if invalid date
            }
            
            return date.toLocaleDateString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        // Helper function to format date for datetime-local input
        function formatDateForInput(dateString) {
            const date = new Date(dateString);
            return date.toISOString().slice(0, 16);
        }
        
        // Create new event that will be automatically featured
        function createNewFeaturedEvent() {
            // Set modal title
            document.getElementById('eventModalLabel').textContent = 'Create New Featured Event';
            
            // Clear form values
            document.getElementById('eventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventVenueName').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventStartDate').value = '';
            document.getElementById('eventEndDate').value = '';
            document.getElementById('eventCategory').value = '';
            document.getElementById('eventImage').value = '';
            document.getElementById('eventFeatured').checked = true; // Auto-feature this event
            
            // Hide delete button for new events
            document.getElementById('deleteEventBtn').style.display = 'none';
            
            // Show modal
            const eventEditModal = new bootstrap.Modal(document.getElementById('eventEditModal'));
            eventEditModal.show();
        }
        
        // Edit event from carousel
        function editCarouselEvent(id) {
            const event = featuredEvents.find(e => e._id === id || e.id === id);
            if (!event) {
                alert('Event not found!');
                return;
            }
            
            // Set modal title
            document.getElementById('eventModalLabel').textContent = 'Edit Featured Event';
            
            // Set form values
            document.getElementById('eventId').value = id;
            document.getElementById('eventTitle').value = event.title || '';
            document.getElementById('eventDescription').value = event.description || '';
            document.getElementById('eventVenueName').value = event.venue?.name || '';
            document.getElementById('eventLocation').value = event.location || '';
            document.getElementById('eventStartDate').value = event.startDate ? formatDateForInput(event.startDate) : '';
            document.getElementById('eventEndDate').value = event.endDate ? formatDateForInput(event.endDate) : '';
            document.getElementById('eventCategory').value = event.category || '';
            document.getElementById('eventImage').value = event.image || '';
            document.getElementById('eventFeatured').checked = true; // It's already featured
            
            // Show delete button
            document.getElementById('deleteEventBtn').style.display = 'block';
            
            // Show modal
            const eventEditModal = new bootstrap.Modal(document.getElementById('eventEditModal'));
            eventEditModal.show();
        }
        
        // Remove event from carousel (unfeaturing it)
        async function removeCarouselEvent(id) {
            if (!confirm('Remove this event from featured? The event will still exist in the database.')) {
                return;
            }
            
            try {
                await removeFeaturedEvent(id);
                renderPreviewEvents(); // Update the carousel immediately
            } catch (error) {
                console.error('Error removing from carousel:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Delete event function
        async function deleteEvent() {
            const id = document.getElementById('eventId').value;
            if (!id) {
                alert('No event selected!');
                return;
            }
            
            if (!confirm('Are you sure you want to delete this event? This action cannot be undone.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/v1/events/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    // Remove from featured if it was featured
                    if (featuredEvents.some(fe => fe._id === id || fe.id === id)) {
                        await removeFeaturedEvent(id);
                    }
                    
                    // Reload events
                    loadAllEvents();
                    loadFeaturedEvents();
                    
                    // Close modal
                    const eventEditModal = bootstrap.Modal.getInstance(document.getElementById('eventEditModal'));
                    eventEditModal.hide();
                    
                    alert('Event deleted successfully!');
                } else {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to delete event');
                }
            } catch (error) {
                console.error('Error deleting event:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Initialize featured events collection if it doesn't exist
        async function initializeFeaturedCollection() {
            try {
                const response = await fetch('/api/v1/featured-events/initialize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Featured events collection initialized successfully!');
                    loadFeaturedEvents(); // Reload featured events
                } else {
                    alert(`Error: ${result.error || 'Unknown error initializing collection'}`);
                }
            } catch (error) {
                console.error('Error initializing featured events collection:', error);
                alert(`Error: ${error.message}`);
            }
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('%c[DEBUG] DOM loaded, initializing admin interface...', 'background: #ffa; color: #00a');
            
            // Log information about critical DOM elements
            const criticalElements = [
                'allEventsList', 'featuredEventsList', 'carousel3d', 'eventSearch',
                'categoryFilter', 'refreshBtn', 'saveFeaturedBtn', 'clearFeaturedBtn'
            ];
            
            criticalElements.forEach(id => {
                const element = document.getElementById(id);
                console.log(`Element '${id}' ${element ? 'found' : 'NOT FOUND'} in DOM`);
            });
            
            // Initialize the carousel first with a loading state
            const carousel = document.getElementById('carousel3d');
            if (carousel) {
                carousel.innerHTML = `
                    <div class="carousel-3d-item" style="transform: rotateY(0deg) translateZ(0px)">
                        <div class="text-center p-5">
                            <div class="spinner-border text-light" role="status"></div>
                            <p class="mt-2 text-light">Loading featured events...</p>
                        </div>
                    </div>
                `;
                console.log('Carousel initialized with loading state');
            } else {
                console.warn('Carousel element not found in DOM');
            }
            
            // Load data
            loadAllEvents();
            loadFeaturedEvents();
            
            // Add event listener for tab changes
            document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', event => {
                    if (event.target.id === 'featured-tab') {
                        console.log('Featured tab activated, refreshing carousel...');
                        renderPreviewEvents();
                    }
                });
            });
        });
    </script>
</body>
</html>
