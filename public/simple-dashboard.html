<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Scraper Dashboard</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        #debug {
            background-color: #f4f4f4;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            margin-bottom: 20px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        button {
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }
        .badge {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 10px;
            color: white;
            margin-right: 5px;
        }
        .badge-venue {
            background-color: #4caf50;
        }
        .badge-event {
            background-color: #2196f3;
        }
        .badge-scraper {
            background-color: #ff9800;
        }
    </style>
</head>
<body>
    <h1>Simple Scraper Dashboard</h1>
    
    <div id="debug">Initializing dashboard...</div>
    
    <div id="controls">
        <button id="loadScrapers">Load Scrapers</button>
        <button id="testVenues">Test /venues API</button>
        <button id="testScrapersList">Test /scrapers/list API</button>
    </div>
    
    <h2>Scrapers</h2>
    <table id="scraperTable">
        <thead>
            <tr>
                <th>Name</th>
                <th>Type</th>
                <th>URL</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        // DOM elements
        const debugEl = document.getElementById('debug');
        const scraperTableBody = document.getElementById('scraperTable').querySelector('tbody');
        
        // Add log function
        function log(message) {
            const time = new Date().toLocaleTimeString();
            debugEl.textContent += `[${time}] ${message}\n`;
            debugEl.scrollTop = debugEl.scrollHeight;
            console.log(message);
        }
        
        // Error handler for fetch
        async function fetchWithErrorHandling(url) {
            log(`Fetching ${url}...`);
            try {
                const response = await fetch(url);
                log(`Response status: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                
                const data = await response.json();
                log(`Data received. First item: ${JSON.stringify(data).substring(0, 100)}...`);
                return data;
            } catch (error) {
                log(`Error fetching ${url}: ${error.message}`);
                throw error;
            }
        }
        
        // Load scrapers
        async function loadScrapers() {
            log('Loading scrapers...');
            scraperTableBody.innerHTML = '';
            
            try {
                // Try /scrapers/list endpoint first
                log('Attempting to load from /api/v1/scrapers/list');
                try {
                    const data = await fetchWithErrorHandling('/api/v1/scrapers/list');
                    if (data.scrapers && Array.isArray(data.scrapers)) {
                        log(`Successfully loaded ${data.scrapers.length} scrapers from /scrapers/list`);
                        renderScrapers(data.scrapers);
                        return;
                    }
                } catch (error) {
                    log('Failed to load from /scrapers/list, falling back to /venues');
                }
                
                // Fall back to /venues endpoint
                const data = await fetchWithErrorHandling('/api/v1/venues');
                if (data.venues && Array.isArray(data.venues)) {
                    log(`Successfully loaded ${data.venues.length} venues`);
                    renderVenues(data.venues);
                    return;
                }
                
                log('No data found in either API endpoint');
            } catch (error) {
                log(`Failed to load scrapers: ${error.message}`);
            }
        }
        
        // Render scrapers from /scrapers/list endpoint
        function renderScrapers(scrapers) {
            scraperTableBody.innerHTML = '';
            
            scrapers.forEach(scraper => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = scraper.name;
                row.appendChild(nameCell);
                
                // Type cell
                const typeCell = document.createElement('td');
                const typeBadge = document.createElement('span');
                typeBadge.className = `badge badge-${(scraper.type || 'scraper').toLowerCase()}`;
                typeBadge.textContent = scraper.type || 'Scraper';
                typeCell.appendChild(typeBadge);
                row.appendChild(typeCell);
                
                // URL cell
                const urlCell = document.createElement('td');
                if (scraper.url) {
                    const link = document.createElement('a');
                    link.href = scraper.url;
                    link.target = '_blank';
                    link.textContent = scraper.url;
                    urlCell.appendChild(link);
                } else {
                    urlCell.textContent = 'N/A';
                }
                row.appendChild(urlCell);
                
                // Actions cell
                const actionsCell = document.createElement('td');
                
                // Test button
                const testButton = document.createElement('button');
                testButton.textContent = 'Test';
                testButton.addEventListener('click', () => testScraper(scraper.name));
                actionsCell.appendChild(testButton);
                
                row.appendChild(actionsCell);
                scraperTableBody.appendChild(row);
            });
        }
        
        // Render venues from /venues endpoint
        function renderVenues(venues) {
            scraperTableBody.innerHTML = '';
            
            venues.forEach(venue => {
                const row = document.createElement('tr');
                
                // Name cell
                const nameCell = document.createElement('td');
                nameCell.textContent = venue.name;
                row.appendChild(nameCell);
                
                // Type cell
                const typeCell = document.createElement('td');
                const typeBadge = document.createElement('span');
                typeBadge.className = `badge badge-${(venue.type || 'venue').toLowerCase()}`;
                typeBadge.textContent = venue.type || 'Venue';
                typeCell.appendChild(typeBadge);
                row.appendChild(typeCell);
                
                // URL cell
                const urlCell = document.createElement('td');
                if (venue.url) {
                    const link = document.createElement('a');
                    link.href = venue.url;
                    link.target = '_blank';
                    link.textContent = venue.url;
                    urlCell.appendChild(link);
                } else {
                    urlCell.textContent = 'N/A';
                }
                row.appendChild(urlCell);
                
                // Actions cell
                const actionsCell = document.createElement('td');
                
                // Test button
                const testButton = document.createElement('button');
                testButton.textContent = 'Test';
                testButton.addEventListener('click', () => testVenue(venue.id));
                actionsCell.appendChild(testButton);
                
                row.appendChild(actionsCell);
                scraperTableBody.appendChild(row);
            });
        }
        
        // Test a scraper by name
        async function testScraper(scraperName) {
            log(`Testing scraper: ${scraperName}`);
            try {
                const formatted = scraperName.toLowerCase().replace(/\s+/g, '-');
                log(`Using formatted scraper name: ${formatted}`);
                
                const response = await fetch(`/api/v1/scrapers/run/${formatted}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ save: false })
                });
                
                log(`Test response status: ${response.status}`);
                const data = await response.json();
                log(`Test results: ${JSON.stringify(data).substring(0, 200)}...`);
                
                if (data.success) {
                    log(`Test succeeded! Found ${data.eventCount} events.`);
                } else {
                    log(`Test failed: ${data.message}`);
                }
            } catch (error) {
                log(`Error testing scraper ${scraperName}: ${error.message}`);
            }
        }
        
        // Test a venue by id
        async function testVenue(venueId) {
            log(`Testing venue: ${venueId}`);
            try {
                const response = await fetch(`/api/v1/venues/${venueId}/events`);
                log(`Test response status: ${response.status}`);
                
                const data = await response.json();
                log(`Test results: ${JSON.stringify(data).substring(0, 200)}...`);
                
                if (data.success) {
                    log(`Test succeeded! Found ${data.events.length} events.`);
                } else {
                    log(`Test failed: ${data.message}`);
                }
            } catch (error) {
                log(`Error testing venue ${venueId}: ${error.message}`);
            }
        }
        
        // Test /venues API directly
        async function testVenuesAPI() {
            log('Testing /api/v1/venues API...');
            try {
                const data = await fetchWithErrorHandling('/api/v1/venues');
                log(`API test result: ${JSON.stringify(data).substring(0, 200)}...`);
            } catch (error) {
                log(`API test failed: ${error.message}`);
            }
        }
        
        // Test /scrapers/list API directly
        async function testScrapersListAPI() {
            log('Testing /api/v1/scrapers/list API...');
            try {
                const data = await fetchWithErrorHandling('/api/v1/scrapers/list');
                log(`API test result: ${JSON.stringify(data).substring(0, 200)}...`);
            } catch (error) {
                log(`API test failed: ${error.message}`);
            }
        }
        
        // Event listeners
        document.getElementById('loadScrapers').addEventListener('click', loadScrapers);
        document.getElementById('testVenues').addEventListener('click', testVenuesAPI);
        document.getElementById('testScrapersList').addEventListener('click', testScrapersListAPI);
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            log('Dashboard initialized.');
            loadScrapers();
        });
    </script>
</body>
</html>
